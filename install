#!/bin/bash

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `install` has finished
while true; do
  sudo -n true
  sleep 60
  kill -0 "$$" || exit
done 2>/dev/null &

function setup-brew {
  if ! [ -x "$(command -v brew)" ]; then
    if ! [ -x "$(command -v /opt/homebrew/bin/brew)" ]; then
      echo "Installing brew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
}

function install-brew-packages {
  local type=$1
  shift
  local installed
  installed=$(brew list --"$type" --versions | awk '{print $1}')
  for pkg in "$@"; do
    if ! grep -qx "$pkg" <<<"$installed"; then
      echo "ðŸ”§ Installing $pkg..."
      if [ "$type" = "cask" ]; then
        brew install --cask "$pkg"
      else
        brew install "$pkg"
      fi
    fi
  done
}

function setup-chezmoi {
  chezmoi init Omico --depth 1 --force
  chezmoi apply
}

function setup-fish {
  # Setup fish as the default shell
  if ! grep -q "/opt/homebrew/bin/fish" /etc/shells; then
    echo "/opt/homebrew/bin/fish" | sudo tee -a /etc/shells
    chsh -s /opt/homebrew/bin/fish
  fi
}

function clone-rime-auto-deploy {
  if [ ! -d "$HOME/Git/Mark24Code/rime-auto-deploy" ]; then
    echo "Cloning rime-auto-deploy..."
    git clone --depth=1 https://github.com/Mark24Code/rime-auto-deploy.git --branch latest "$HOME/Git/Mark24Code/rime-auto-deploy"
  fi
  cp -u "$HOME/.local/share/chezmoi/rime/"*.custom.yaml "$HOME/Git/Mark24Code/rime-auto-deploy/custom"
}

setup-brew

brew_formula_packages=(
  chezmoi
  fish
  git
  starship
)
install-brew-packages formula "${brew_formula_packages[@]}"

brew_cask_packages=(
  font-fira-mono-nerd-font
  iterm2
  visual-studio-code
)
install-brew-packages cask "${brew_cask_packages[@]}"

setup-chezmoi

setup-fish

clone-rime-auto-deploy
